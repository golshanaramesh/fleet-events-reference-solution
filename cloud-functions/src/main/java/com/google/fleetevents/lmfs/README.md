## Overview

The Fleet Events Reference Solution provides a ready to deploy implementation of
a Cloud Function that you can use to get alerts on state changes to Delivery
Vehicles and Tasks in the Last Mile Fleet Solution (LMFS) product.

<figure id = "image-1">
  <img src = "../../../../../resources/img/Fleet%20Events%20Overview.jpg"
  width = "100%"
  alt = "Flow chart detailing how Fleet Events processes incoming cloud logs.">
  <figcaption><b>Figure 1.</b> Flow chart of Fleet Events.</figcaption>
</figure>

## How to Use this Document

Read this document fully to understand how Fleet Events generates alerts from
Cloud Logs. You should understand how events are created, how they are routed to
the correct handler, and how handlers can use these internal events to output
their own events to a Pub/Sub sink.

## Event Creation

Event creation is handled inside the FleetEventCreator class, consuming logs
from Cloud Logging to generate the internal state changes for updates.

There are two types of events generated:

- **DeliveryVehicleFleetEvents** have information related to eta, distance,
  location, and the list of stops along with task ids the vehicle currently is
  executing.
- **DeliveryTaskFleetEvents** have information related solely to the task such
  as state, task outcome, name, id, etc. ETA and distance updates are not
  generated by these events.

When an update is made to one of the fields an internal event object of type
FleetEvent is propagated throughout the code and handlers decide whether they
want to respond to them.

## Event Handling

Fleet Event Handlers take in the internal event objects that are created within
the transactions and use them to optionally update any metadata they have about
the task/vehicle and decide whether they want to output an external event to one
of the sinks registered with the main fleet event function.

Handlers are registered with the main Fleet Events function and whenever an
internal fleet event is generated from within a transaction are called with the
event as well as the transaction object that generated the event. The
`respondsTo` method is used by the Fleet Event handler to determine whether the
event is something it needs to respond to, as well as an opportunity to add any
get calls to the transaction to retrieve business specific data that may be
necessary in deciding to respond or not.

When the handler is configured to respond, the handleEvent method takes in the
event and the transaction again and can output external OutputEvents depending
on the objects' state update and metadata. `handleEvent` can also be used to add
to the transaction by adding set operations to support custom business logic.

**Note**: In a Firestore transaction, all get operations must be issued before
set operations to avoid retry loops.

See:

- TaskOutcomeHandler
- EtaChangeHandler
- TimeRemainingHandler
- DistanceRemainingHandler

<figure id = "image-2">
  <img src = "../../../../../resources/img/Fleet%20Events%20Flow%20Diagram.jpg"
  width = "100%"
  alt = "Flow chart detailing how Fleet Events processes incoming cloud logs.">
  <figcaption><b>Figure 2.</b> Flow chart of Fleet Events.</figcaption>
</figure>
## Event Output

By default, the output events are converted to a JSON format and written out to
a
Pub/Sub Output Topic. Output Events emitted by the preprovided handlers inherit
from the OutputEvent class and by default contain a copy of the internal fleet
event that triggered the event.

New sinks can be added in the FleetEventFunction to allow writing directly to
clients such as SMS, Slack, or other

See:

- TaskOutcomeOutputEvent
- EtaOutputEvent
- TimeRemainingOutputEvent
- DistanceRemainingOutputEvent

## Contributors

Google maintains this article. The following contributors originally wrote it.

Principal authors:

- Ethel Bao | Software Engineer, Google Maps Platform
- Mohanad Almiski | Software Engineer, Google Maps Platform
- Naoya Moritani | Solutions Engineer, Google Maps Platform
